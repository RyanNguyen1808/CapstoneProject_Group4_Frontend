name: Angular CI

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      S3_BUCKET_NAME: ${{ steps.set_outputs.outputs.S3_BUCKET_NAME }}
      CLOUDFRONT_DISTRIBUTION_ID: ${{ steps.set_outputs.outputs.CLOUDFRONT_DISTRIBUTION_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_NTU }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_NTU }}
          aws-region: ${{secrets.AWS_REGION_NTU}}
          
      - name: Fetch SSM parameter
        id: ssm
        run: |
          PARAM=$(aws ssm get-parameter \
            --region "${{ secrets.AWS_REGION_NTU }}" \
            --name "${{ secrets.SSM_PARAMETER_NAME }}" \
            --with-decryption \
            --query "Parameter.Value" \
            --output text)
          echo "PARAM=$PARAM" >> $GITHUB_ENV

      - name: Parse JSON and export variables
        run: |
          export CLOUDFRONT_DISTRIBUTION_ID=$(echo $PARAM | jq -r '.cloudfront_distribution_id')
          export USER_POOL_ID=$(echo $PARAM | jq -r '.cognito_user_pool_id')
          export USER_POOL_APP_ID=$(echo $PARAM | jq -r '.cognito_app_client_id')
          export BASE_URL=$(echo $PARAM | jq -r '.base_url')
          export S3_BUCKET_NAME=$(echo $PARAM | jq -r '.s3_bucket_name')
          echo "CLOUDFRONT_DISTRIBUTION_ID=$CLOUDFRONT_DISTRIBUTION_ID"
          echo "USER_POOL_ID=$USER_POOL_ID"
          echo "USER_POOL_APP_ID=$USER_POOL_APP_ID"
          echo "BASE_URL=$BASE_URL" 
          echo "S3_BUCKET_NAME=$S3_BUCKET_NAME"
          echo "CLOUDFRONT_DISTRIBUTION_ID=$CLOUDFRONT_DISTRIBUTION_ID" >> $GITHUB_ENV
          echo "USER_POOL_ID=$USER_POOL_ID" >> $GITHUB_ENV
          echo "USER_POOL_APP_ID=$USER_POOL_APP_ID" >> $GITHUB_ENV
          echo "BASE_URL=$BASE_URL" >> $GITHUB_ENV
          echo "S3_BUCKET_NAME=$S3_BUCKET_NAME" >> $GITHUB_ENV
      
      - name: Set outputs for deploy
        id: set_outputs
        run: |
          echo "S3_BUCKET_NAME=${S3_BUCKET_NAME}" >> $GITHUB_OUTPUT
          echo "CLOUDFRONT_DISTRIBUTION_ID=${CLOUDFRONT_DISTRIBUTION_ID}" >> $GITHUB_OUTPUT

      - name: Inject prod environment.ts
        run: |
          mkdir -p src/app/environments
          echo "export const environment = {" > src/app/environments/environment.ts
          echo "  production: true," >> src/app/environments/environment.ts
          echo "  userPoolId: '${{ env.USER_POOL_ID }}'," >> src/app/environments/environment.ts
          echo "  userPoolClientId: '${{ env.USER_POOL_APP_ID }}'," >> src/app/environments/environment.ts
          echo "  baseURL: '${{ env.BASE_URL }}'" >> src/app/environments/environment.ts
          echo "};" >> src/app/environments/environment.ts

      - name: Install dependencies
        run: npm ci

      - name: Build Angular app
        run: npm run build -- --configuration production

      - name: Archive build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: angular-dist
          path: dist/
      
  deploy:
    needs: build  # <- THIS makes deploy wait for build
    uses: ./.github/workflows/cd.yaml
    secrets:
      AWS_ACCESS_KEY_ID_NTU: ${{ secrets.AWS_ACCESS_KEY_ID_NTU }}
      AWS_SECRET_ACCESS_KEY_NTU: ${{ secrets.AWS_SECRET_ACCESS_KEY_NTU }}
      AWS_REGION_NTU: ${{ secrets.AWS_REGION_NTU }}      
      S3_BUCKET_NAME: ${{ needs.build.outputs.S3_BUCKET_NAME }}
      CLOUDFRONT_DISTRIBUTION_ID: ${{ needs.build.outputs.CLOUDFRONT_DISTRIBUTION_ID }}
